---
title: "flat_money_transfer.Rmd for working package"
output: html_document
editor_options: 
  chunk_output_type: console
---

# What's this package about? 
Divide the costs of a group undertaking. If you go hiking with your friends the whole group has some costs that need to be divided. If you always share evenly the division can be unfair. What if somebody had to leave early? What if somebody only participated in some activities? What if somebody booked a seat but couldnt show up? What if there is a person who earns less and others would like to chip in? What if there were children who eat less than a full grown adult? This R package tries to balance these problems to have a fair distribution. Friendship is great and all the accounting should be smooth and unproblematic. 

# How to use this package
So you are convinced that this package is something for you? You want to give it a try? Go ahead. Follow the following steps to divide the costs of an activity fair amongst all participants

## Install and load the package
The package uses R. The package can be installed using devtools and the loaded into R

```
devtools::install_github(github.com/jakobschumacher/dividefair)
library(dividefair)
```

## Prepare input files
This is the tricky part of the undertaking. You need to have two files where you collect all the information that you need. Fortunately you can use those files also during the planning of the group activity - so next time you start with a group activity write down the information acording to the following scheme. 

> The `participants.csv` file. This should be a csv file. There should be 4 types of columns in that file: person columns (something like *id*, *name* or *age*), grouping columns (usually called *group*), cost columns (that all start with the prefix *cost_* and the continue with the name of the cost) and lastely and adjustment column (called *adjustment*). You can have a look at the example file [participants.csv](inst/participants.csv)

> The `costs.csv` file. This file contains all the costs. One column must be *id*, one column must be the name of the cost and one column should contain the actual cost. You can have a look at the example file [costs.csv](inst/costs.csv)

## Run the analysis
This is the easy part. If the input files are in structured in the right way, all you need to do is run:

```
divide_fairly(participants_file = "link_to_participants_file.csv", costs_file = "link_to_costs_file.csv")
```

What this will do is: It reads in the files, checks if the files are structured in the right way, changes categorical values into numerical values, it calculates a weight based on the age, adjustment and the grade of involvement. In the end it gives out the amount that everybody needs to pay and whom the money should be paid.


# This is the documentation of all functions of the package

```{r development-dataset}
# Run all this chunk in the console directly
# There already is a dataset in the "inst/" directory
# Make the dataset file available to the current Rmd during development
pkgload::load_all(path = here::here(), export_all = FALSE)

```

## Function to check conformity of dataset
This is a helper function that checks if the two data files are in the right format

## Function to change the categorical values to numerical values 
This is a helper function that is used in the read_data function. In the cost variables we accept categorical values. These categorical values need to be turned into numeric values 

```{r function-change_categorical_to_numeric}
#' Change Categorical Values to Numeric
#'
#' This function converts categorical descriptive values in the columns `present`, `adjustment`, and `age` to numeric values.
#'
#' @param df A dataframe containing the columns `present`, `adjustment`, and `age`. Default is `df`.
#' @param present_reduced A string representing the numeric value to assign when `present` is "reduced". Default is `"0.7"`.
#' @param adjustment_less A string representing the numeric value to assign when `adjustment` is "less". Default is `"0.8"`.
#' @param adjustment_more A string representing the numeric value to assign when `adjustment` is "more". Default is `"1.2"`.
#'
#' @return A dataframe with the `present`, `adjustment`, and `age` columns transformed to numeric values, replacing descriptive values with specified numeric equivalents.
#' @details The function transforms:
#'   - The `present` column: "full" becomes `1`, "reduced" becomes the value of `present_reduced`, and `NA` values become `0`. 
#'   - The `adjustment` column: "more" becomes the value of `adjustment_more`, "less" becomes the value of `adjustment_less`, and `NA` values become `1`.
#'   - The `age` column: `NA` values are replaced with `18`.
#'
#' @export
change_categorical_to_numeric <- function(df = read_data(), 
                                          present_reduced = "0.7", 
                                          adjustment_less = "0.8", 
                                          adjustment_more = "1.2"){
  df |> 
    dplyr::mutate(present = dplyr::case_when(
      present == "full" ~ "1",
      present == "reduced" ~ present_reduced,
      is.na(present) ~ "0",
      TRUE ~ present
    )) |> 
    dplyr::mutate(present = as.numeric(present))  |>
    dplyr::mutate(adjustment = dplyr::case_when(
      adjustment == "more" ~ adjustment_more,
      adjustment == "less" ~ adjustment_less,
      is.na(adjustment) ~ "1",
      TRUE ~ adjustment
    )) |> 
    dplyr::mutate(adjustment = as.numeric(adjustment)) |> 
    dplyr::mutate(age = dplyr::case_when(
      is.na(age) ~ 18,
      TRUE ~ age
    ))
}
```

```{r examples-change_categorical_to_numeric}
df <- change_categorical_to_numeric()
```


```{r tests-change_categorical_to_numeric}
df <- change_categorical_to_numeric()
testthat::test_that("read_data works properly with internal dataset", {
  testthat::expect_equal(is.numeric(df$adjustment), TRUE)
})
```



## Function to read the participants file
This is a helper function that reads in the data from the participant file
```{r function-read_data}
#' Read data
#'
#' @param path A file path to the participant.csv file
#'
#' @return
#' a data frame
#' @export
#'
#' @importFrom dplyr mutate case_when
#' @importFrom tidyr pivot_longer
#' @importFrom  readr read_csv
#' @importFrom  janitor clean_names
#' @examples
read_data <- function(path = system.file("participants.csv", package = "dividefair"),
                      var_agegroup = "agegroup",
                      value_adults = "adult",
                      value_kids = "kid",
                      indicator_costs = "cost",
                      var_present = "present") {
  
   
  # Define patterns for adults and kids in both English and German
  adult_patterns <- tolower(c("adult", "adults", "erwachsene", "erwachsenen"))
  kid_patterns <- tolower(c("kid", "kids", "kind", "kinder")) 

  readr::read_csv(path, show_col_types = FALSE) |> 
    janitor::clean_names() |> 
    dplyr::rename(!!var_agegroup := agegroup) |>
    dplyr::mutate(!!var_agegroup := dplyr::case_when(
      tolower(!!dplyr::sym(var_agegroup)) %in% adult_patterns ~ value_adults,
      tolower(!!dplyr::sym(var_agegroup)) %in% kid_patterns ~ value_kids,
      TRUE ~ !!dplyr::sym(var_agegroup) # Keep the original value if it doesn't match
    )) |> 
    tidyr::pivot_longer(starts_with(indicator_costs), names_to = indicator_costs, values_to = var_present)
}

```


```{r examples-read_data}
df <- read_data(path = system.file("participants.csv", package = "dividefair"))

```

```{r tests-read_data}
# Test with your dataset in "inst/"
df <- read_data(path = system.file("participants.csv", package = "dividefair"))
# Apply test on my function
testthat::test_that("read_data works properly with internal dataset", {
  testthat::expect_equal(nrow(read_data(system.file("participants.csv", package = "dividefair"))), 124)
})
```


## Function to read the costs file
This is a helper function that reads in the data from the participant file


## Function to collect some basic stats 
This function collects some basic stats about the activity and the participants
```{r function-get_stats}
#' Get Statistics on Participants
#'
#' This function calculates statistics regarding the number of adults, children, stays, and absences
#' in a given data frame based on the `agegroup` and `present` columns.
#'
#' @param df A data frame containing at least the following columns:
#'   - `agegroup`: A character vector indicating whether the participant is an "adult" or a "kid".
#'   - `present`: A character vector indicating presence with values "x" for stays and "n" for absences.
#'
#' @return A list containing:
#'   - `adults`: The total number of adults in the data frame.
#'   - `children`: The total number of children in the data frame.
#'   - `no_of_stays`: The total number of stays indicated by "x" in the `present` column.
#'   - `no_of_absences`: The total number of absences indicated by "n" in the `present` column.
#'
#'
#' @export
get_stats <- function(df = read_data()) {
  stats <- list()
  stats$adults <- sum(df$agegroup == "adult" , na.rm = TRUE)
  stats$children <- sum(df$agegroup == "kid", na.rm = TRUE)
  return(stats)
}
```

```{r examples-get_stats}
get_stats(read_data())

```

```{r tests-get_stats}
testthat::test_that("read_data works properly with internal dataset", {
  testthat::expect_equal(get_stats(read_data())$adults, 88)
})
```

## Function to calculate the share
```{r function-divide_costs}
#' Divide Costs Based on Weighted Factors
#'
#' This function calculates how much each individual should pay, based on various weighted factors such as age group, adjustment, and presence.
#'
#' @param df A dataframe containing the columns `agegroup`, `age`, `adjustment`, and `present`. Default is `df`.
#' @param cost The total cost to be divided among individuals. Default is `5500`.
#'
#' @return A dataframe with an additional column `to_pay`, representing the calculated cost each individual needs to pay based on their weight.
#' @details The function computes a `weight` for each individual based on:
#'   - Initializing `weight` to `1`.
#'   - If `agegroup` is `"kid"`, the weight is updated to `weight * 0.0555 * age`.
#'   - The weight is further multiplied by values in `adjustment` and `present` columns.
#'   - The total cost (`cost`) is divided based on the sum of weights to determine each individual's share.
#'
#' @importFrom dplyr mutate case_when
#' @export
divide_costs <- function(df = read_data() |> change_categorical_to_numeric(), cost = 5500) {
  df |> 
    dplyr::mutate(weight = 1) |> 
    dplyr::mutate(weight = dplyr::case_when(
      agegroup == "kid" ~ weight * 0.0555 * age,
      TRUE ~ weight
    )) |> 
    dplyr::mutate(weight = weight * adjustment) |> 
    dplyr::mutate(weight = weight * present) |> 
    dplyr::mutate(weight = as.numeric(weight)) |> 
    dplyr::mutate(to_pay = (weight * 5500) / sum(weight, na.rm = TRUE))
}
```

```{r example-divide_costs}
df <- divide_costs()
```

```{r tests-divide_costs}
df <- divide_costs()
testthat::test_that("read_data works properly with internal dataset", {
  testthat::expect_equal(sum(df$to_pay), 5500)
})
```

## Function to give you amount each has to pay
divide_fairly


