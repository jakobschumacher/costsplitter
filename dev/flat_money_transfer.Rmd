---
title: "flat_money_transfer.Rmd for working package"
output: html_document
editor_options: 
  chunk_output_type: console
---

# What's this package about? 
Divide the costs of a group undertaking. If you go hiking with your friends the whole group has some costs that need to be divided. If you always share evenly the division can be unfair. What if somebody had to leave early? What if somebody only participated in some activities? What if somebody booked a seat but couldnt show up? What if there is a person who earns less and others would like to chip in? What if there were children who eat less than a full grown adult? This R package tries to balance these problems to have a fair distribution. Friendship is great and all the accounting should be smooth and unproblematic. 

# How to use this package
So you are convinced that this package is something for you? You want to give it a try? Go ahead. Follow the following steps to divide the costs of an activity fair amongst all participants

## Install and load the package
The package uses R. The package can be installed using devtools and the loaded into R

```
devtools::install_github(github.com/jakobschumacher/dividefair)
library(dividefair)
```

## Prepare input files
This is the tricky part of the undertaking. You need to have two files where you collect all the information that you need. Fortunately you can use those files also during the planning of the group activity - so next time you start with a group activity write down the information acording to the following scheme. 

> The `participants.csv` file. This should be a csv file. There should be 4 types of columns in that file: person columns (something like *id*, *name* or *age*), grouping columns (usually called *group*), cost columns (that all start with the prefix *cost_* and the continue with the name of the cost) and lastely and adjustment column (called *adjustment*). You can have a look at the example file [participants.csv](inst/participants.csv)

> The `costs.csv` file. This file contains all the costs. One column must be *id*, one column must be the name of the cost and one column should contain the actual cost. You can have a look at the example file [costs.csv](inst/costs.csv)

## Run the analysis
This is the easy part. If the input files are in structured in the right way, all you need to do is run:

```
divide_fairly(participants_file = "link_to_participants_file.csv", costs_file = "link_to_costs_file.csv")
```

What this will do is: It reads in the files, checks if the files are structured in the right way, changes categorical values into numerical values, it calculates a weight based on the age, adjustment and the grade of involvement. In the end it gives out the amount that everybody needs to pay and whom the money should be paid.


# This is the documentation of all functions of the package

```{r development-dataset}
# Run all this chunk in the console directly
# There already is a dataset in the "inst/" directory
# Make the dataset file available to the current Rmd during development
pkgload::load_all(path = here::here(), export_all = FALSE)

```


## Function to read costs file
This is a helper function that reads in the data from the participant file.
```{r function-read_costs}
#' Read Cost Data from CSV File
#'
#' This function reads cost data from a CSV file, defaulting to the "costs.csv" 
#' file included in the dividefair package.
#'
#' @param path A character string specifying the path to the CSV file. 
#'   Defaults to the "costs.csv" file included in the dividefair package.
#'
#' @return A tibble containing the cost data read from the CSV file.
#'
#' @importFrom readr read_csv
#'
#' @export
read_costs <- function(path = system.file("costs.csv", package = "dividefair")){
  readr::read_csv(path, show_col_types = FALSE) 
}
```

```{r example-read_costs}
data_costs <- dividefair::read_costs()
```

```{r test-read_costs}
data_costs <- dividefair::read_costs()
testthat::test_that("read_costs works properly with internal dataset", {
  testthat::expect_equal(nrow(data_costs), 5)
})
```



## Function to read the participants file
This is a helper function that reads in the data from the participant file
```{r function-read_participants}
#' Read and Process Participant Data from CSV
#'
#' This function reads a CSV file containing participant data, cleans and processes it,
#' and returns a tidy data frame. It allows for flexible column naming and handles
#' various CSV structures.
#'
#' @param path A string. The file path to the CSV file.
#' @param var_id A string. The name of the ID column in the CSV (default: "id").
#' @param var_age A string. The name of the age column in the CSV (default: "age").
#' @param var_group A string. The name of the group column in the CSV (default: "group").
#' @param var_adjustment A string. The name of the adjustment column in the CSV (default: "adjustment").
#' @param indicator_costs A string. The prefix for cost columns in the CSV (default: "cost_").
#' @param var_agegroup A string. The name of the age group column in the CSV (default: "agegroup").
#' @param value_adults A string. The value to use for adult age groups (default: "adult").
#' @param value_kids A string. The value to use for kid age groups (default: "kid").
#'
#' @return A tibble (data frame) containing the processed participant data.
#'
#' @details
#' The function performs the following operations:
#' 1. Reads the CSV file
#' 2. Cleans column names
#' 3. Renames columns based on user-provided names
#' 4. Processes the age group column, categorizing into adults and kids
#' 5. Pivots cost columns into a long format
#'
#'
#' @import dplyr
#' @import tidyr
#' @import readr
#' @import janitor
#' @importFrom rlang sym
#'
#' @export
read_participants <- function(path = system.file("participants.csv", package = "dividefair"),
                      var_id = "id",
                      var_age = "age",
                      var_group = "group",
                      var_adjustment = "adjustment",
                      var_agegroup = "agegroup",
                      indicator_costs = "cost_",
                      value_adults = "adult",
                      value_kids = "kid") {
  
  # Define patterns for adults and kids in both English and German
  adult_patterns <- tolower(c("adult", "adults", "erwachsene", "erwachsenen"))
  kid_patterns <- tolower(c("kid", "kids", "kind", "kinder"))
  
  # Read the CSV file
  data <- readr::read_csv(path, show_col_types = FALSE)
  
  # Clean column names
  data <- janitor::clean_names(data)
  
  # Rename columns based on user-provided names
  data <- data %>%
    dplyr::rename(
      id = !!rlang::sym(var_id),
      age = !!rlang::sym(var_age),
      group = !!rlang::sym(var_group),
      adjustment = !!rlang::sym(var_adjustment),
      !!var_agegroup := !!rlang::sym(var_agegroup)
    )
  
  # Process the agegroup column
  data <- data %>%
    dplyr::mutate(!!var_agegroup := dplyr::case_when(
      tolower(!!rlang::sym(var_agegroup)) %in% adult_patterns ~ value_adults,
      tolower(!!rlang::sym(var_agegroup)) %in% kid_patterns ~ value_kids,
      TRUE ~ !!rlang::sym(var_agegroup) # Keep the original value if it doesn't match
    ))
  
  # Identify cost columns
  cost_cols <- grep(paste0("^", indicator_costs), names(data), value = TRUE)
  
  # Pivot longer for cost columns
  data <- data %>%
    tidyr::pivot_longer(all_of(cost_cols), names_to = "cost_type", values_to = "share")
  
  return(data)
}


```


```{r examples-read_participants}
data_participants <- read_participants()

```

```{r tests-read_participants}
# Test with your dataset in "inst/"
data_participants <- read_participants()
data_costs <- dividefair::read_costs()
# Apply test on my function
testthat::test_that("read_participants works properly with internal dataset", {
  testthat::expect_equal(nrow(data_participants), 124)
})

# testthat::test_that("All IDs in costs are also in the participants file ", {
#   testthat::expect_true(all(data_costs$id %in% data_participants$id))
# })

```


## Function to check conformity of dataset
This is a helper function that checks if the two data files are in the right format


## Function to change the categorical values to numerical values 
This is a helper function that is used in the read_participants function. In the cost variables we accept categorical values. These categorical values need to be turned into numeric values 

```{r function-change_categorical_to_numeric}
#' Change Categorical Values to Numeric
#'
#' This function converts categorical descriptive values in the columns `share`, `adjustment`, and `age` to numeric values.
#'
#' @param data_participants A dataframe containing the columns `share`, `adjustment`, and `age`. Default is `data_participants`.
#' @param share_reduced A string representing the numeric value to assign when `share` is "reduced". Default is `"0.7"`.
#' @param adjustment_less A string representing the numeric value to assign when `adjustment` is "less". Default is `"0.8"`.
#' @param adjustment_more A string representing the numeric value to assign when `adjustment` is "more". Default is `"1.2"`.
#'
#' @return A dataframe with the `share`, `adjustment`, and `age` columns transformed to numeric values, replacing descriptive values with specified numeric equivalents.
#' @details The function transforms:
#'   - The `share` column: "full" becomes `1`, "reduced" becomes the value of `share_reduced`, and `NA` values become `0`. 
#'   - The `adjustment` column: "more" becomes the value of `adjustment_more`, "less" becomes the value of `adjustment_less`, and `NA` values become `1`.
#'   - The `age` column: `NA` values are replaced with `18`.
#'
#' @export
change_categorical_to_numeric <- function(data_participants = read_participants(), 
                                          share_reduced = 0.7, 
                                          adjustment_less = 0.8, 
                                          adjustment_more = 1.2) {
  data_participants |> 
    dplyr::mutate(share = dplyr::case_when(
      .data$share == "full" ~ 1,
      .data$share == "reduced" ~ share_reduced,
      is.na(.data$share) ~ 0,
      TRUE ~ as.numeric(.data$share)
    )) |> 
    dplyr::mutate(adjustment = dplyr::case_when(
      .data$adjustment == "more" ~ adjustment_more,
      .data$adjustment == "less" ~ adjustment_less,
      is.na(.data$adjustment) ~ 1,
      TRUE ~ as.numeric(.data$adjustment)
    )) |> 
    dplyr::mutate(age = dplyr::case_when(
      is.na(.data$age) ~ 18,
      TRUE ~ as.numeric(.data$age)
    ))
}
```

```{r examples-change_categorical_to_numeric}
data_participants <- change_categorical_to_numeric()
```


```{r tests-change_categorical_to_numeric}
data_participants <- change_categorical_to_numeric()
testthat::test_that("The function change categorical to numeric works fine", {
  testthat::expect_equal(is.numeric(data_participants$adjustment), TRUE)
})
```






## Function to collect some basic stats 
This function collects some basic stats about the activity and the participants
```{r function-get_stats}
#' Get Statistics on Participants
#'
#' This function calculates statistics regarding the number of adults, children, stays, and absences
#' in a given data frame based on the `agegroup` and `share` columns.
#'
#' @param data_participants A data frame containing at least the following columns:
#'   - `agegroup`: A character vector indicating whether the participant is an "adult" or a "kid".
#'   - `share`: A character vector indicating presence with values "x" for stays and "n" for absences.
#'
#' @return A list containing:
#'   - `adults`: The total number of adults in the data frame.
#'   - `children`: The total number of children in the data frame.
#'
#'
#' @export
get_stats <- function(data_participants = read_participants()) {
  stats <- list()
  stats$adults <- sum(data_participants$agegroup == "adult" , na.rm = TRUE)
  stats$children <- sum(data_participants$agegroup == "kid", na.rm = TRUE)
  return(stats)
}
```

```{r examples-get_stats}
get_stats(read_participants())

```

```{r tests-get_stats}
data_participants <- read_participants()
testthat::test_that("The function get stats works fine", {
  testthat::expect_equal(get_stats(data_participants$adults, 88))
})
```

## Function to calculate the share
```{r function-divide_costs}
#' Divide Costs Based on Weighted Factors
#'
#' This function calculates how much each individual should pay, based on various weighted factors such as age group, adjustment, and presence.
#'
#' @param data_participants A dataframe containing the columns `agegroup`, `age`, `adjustment`, and `share`. Default is `data_participants`.
#' @param cost The total cost to be divided among individuals. Default is `5500`.
#'
#' @return A dataframe with an additional column `to_pay`, representing the calculated cost each individual needs to pay based on their weight.
#' @details The function computes a `weight` for each individual based on:
#'   - Initializing `weight` to `1`.
#'   - If `agegroup` is `"kid"`, the weight is updated to `weight * 0.0555 * age`.
#'   - The weight is further multiplied by values in `adjustment` and `share` columns.
#'   - The total cost (`cost`) is divided based on the sum of weights to determine each individual's share.
#'
#' @importFrom dplyr mutate case_when
#' @export
divide_costs <- function(data_participants = read_participants() |> change_categorical_to_numeric(), cost = 5500) {
  data_participants |> 
    dplyr::mutate(weight = 1) |> 
    dplyr::mutate(weight = dplyr::case_when(
      .data$agegroup == "kid" ~ .data$weight * 0.0555 * .data$age,
      TRUE ~ .data$weight
    )) |> 
    dplyr::mutate(weight = .data$weight * .data$adjustment) |> 
    dplyr::mutate(weight = .data$weight * .data$share) |> 
    dplyr::mutate(weight = as.numeric(.data$weight)) |> 
    dplyr::mutate(to_pay = (.data$weight * cost) / sum(.data$weight, na.rm = TRUE))
}
```

```{r example-divide_costs}
data_participants <- divide_costs()
```

```{r tests-divide_costs}
data_participants <- divide_costs()
testthat::test_that("The function divide costs works properly with internal dataset", {
  testthat::expect_equal(sum(data_participants$to_pay), 5500)
})
```

## Function to give you amount each has to pay
divide_fairly


